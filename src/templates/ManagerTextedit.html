<!DOCTYPE html>
    <head>
            <meta charset="UTF-8">
            <title>管理員使用規則修改</title>
            <!-- 引入 Quill 的 CSS 和 JavaScript -->
        <script src="https://cdn.quilljs.com/1.3.6/quill.js"></script>
        <script src="https://cdn.quilljs.com/1.3.6/quill.min.js"></script>
        <script src="/js/ManagerTextedit.js"></script>
        <link href="https://cdn.quilljs.com/1.3.6/quill.snow.css" rel="stylesheet">
        <link href="https://cdn.quilljs.com/1.3.6/quill.bubble.css" rel="stylesheet">
        <link rel="stylesheet" href="/css/ManagerTextedit.css">
    </head>
    <body>
        <!-- 左邊選單 -->
        <div class="menu">
            <h3 class="menu-title" id="menu-title1">歡迎登入</h3>
            <h3 id="accountName" class="menu-title" ></h3>
            <div class="page-choose">
                <div id="privilege" class="choice" onclick="changePage(this)">
                    <h3 class="pagetext">權限管理</h3>
                </div>
                <div id="conference" class="choice" onclick="changePage(this)">
                    <h3  class="pagetext">會議管理</h3>
                </div>
                <div id="board" class="choice" onclick="changePage(this)">
                    <h3  class="pagetext">看板管理</h3>
                </div>
                <div id="rules" class="choice"  onclick="changePage(this)">
                    <h3 class="pagetext">使用規則</h3>
                </div>
                <div id="log" class="choice" onclick="changePage(this)">
                    <h3  class="pagetext">登入紀錄</h3>
                </div>
            </div>
        </div>

        <!-- 使用者/管理者 -->
        <div class="useradmin" onclick=""> 
            <img src="/image/user.png"  class="useradmin-button" onclick="location.href ='/page/userlobby'">
            <hr style="margin: 0; height: 100%;" />
            <img src="/image/admin.png" class="useradmin-button" onclick="location.href ='/page/privilege'">
        </div>

        <!--
  Example playground for guide series learning hot to crate a Block Tool for Editor.js
  https://editorjs.io/creating-a-block-tool
-->
<style>
    body {
        font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", "Roboto", "Oxygen", "Ubuntu", "Cantarell", "Fira Sans", "Droid Sans", "Helvetica Neue", sans-serif;
        font-size: 14px;
        line-height: 1.5em;
    }
</style>

<script src="https://cdn.jsdelivr.net/npm/@editorjs/editorjs@latest"></script>
<script src="/js/text_editor.js"></script>
<link href="/css/text_editor.css" rel="stylesheet"/>

<div id="editorjs" style="max-width: 1000px; margin: 0 auto"></div>

<button id="save-button">Save</button>

<script>
function changeHyphen(editorInput) {
    // Save the caret position before modifying the text
  const selection = window.getSelection();
  const range = selection.getRangeAt(0);
  const startOffset = range.startOffset;
    // Modify the text content (replace '- ' with your desired character)
    editorInput.textContent = editorInput.textContent.replace('- ', '• ');
    // Restore the caret position after modifying the text
  const newRange = document.createRange();
  newRange.setStart(editorInput.childNodes[0], startOffset); // Adjust position after text modification
  newRange.collapse(true);
  selection.removeAllRanges();
  selection.addRange(newRange);
}

function setId(editorInput) {
  // set the id of this div element to the text content before the space
  const id = editorInput.textContent.split(' ')[1]
  editorInput.id = id;
  console.log(editorInput);
}

document.addEventListener('keyup', (event) => {
  const editorInput = document.activeElement;


  // Only replace '- ' at the beginning of the input
  if (editorInput.textContent.startsWith('- ')) {
    changeHyphen(editorInput);
  }
  // If the input starts with '# ', set the id of the div element to the text content after the space
  else if (editorInput.textContent.startsWith('# ')) {
    setId(editorInput);
  }
});

function getBlocksFromData(data) {
    blocks = [];
    for (let i = 0; i < data.length; i++) {
      blocks.push({data : data[i].data, type: data[i].type});
    }
    return blocks;
 
  }

  async function getBlocks(doc_name) {
    console.log(`/api/doc?doc_name=${doc_name}`)
    const res = await fetch(`/api/doc?doc_name=${doc_name}`, {
      method: 'GET',
      headers: {
        'Content-Type': 'application/json',
      },
    })
    const data = await res.json();
    console.log(data.data.blocks);
    return JSON.parse(data.data.blocks);
  };

    /**
     * Initialize the Editor
     */
    const editor = new EditorJS({
        autofocus: true,
        tools: {
            image: {
            class: SimpleImage,
            inlineToolbar: true,
            config: {
                placeholder: 'Paste image URL'
            }
            }
        },
        data: {
            version: "2.11.10"
        }
    });

    // Set the blocks in the editor
    async function setBlocks() {
        let blocks = await getBlocks('rules');
        // If there are no blocks, set the default block content
        if (blocks == false) {
          blocks = [{
            type: "paragraph",
            data: {
              text: "請在此輸入內容"
            }
          }]
        }
        console.log(blocks);
        
        editor.render({blocks: blocks, version: "2.11.10"});
    };

    // Wait for the editor to be initialized before setting the blocks
    setTimeout(() => {
      setBlocks(editor);
    }, "100");
    


    /**
   * Add handler for the Save button
   */
    // Send blocks to the backend
    async function sendBlocks(blocks, doc_name) {
        const res = await fetch('/api/doc', {
            method: 'POST',
            headers: {
            'Content-Type': 'application/json',
            },
            body: JSON.stringify({blocks: blocks, doc_name:doc_name}),

        })
    }



  const saveButton = document.getElementById('save-button');
  const output = document.getElementById('output');

  saveButton.addEventListener('click', () => {
    editor.save().then( savedData => {
      const doc_name = prompt("請輸入文件名稱");
      const blocks = getBlocksFromData(savedData.blocks);
      sendBlocks(blocks, doc_name);
    })
  })
</script>


    </body>
</html>